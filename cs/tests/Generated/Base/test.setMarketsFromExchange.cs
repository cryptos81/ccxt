using ccxt;
using ccxt.pro;
namespace Tests;

// PLEASE DO NOT EDIT THIS FILE, IT IS GENERATED AND WILL BE OVERWRITTEN:
// https://github.com/ccxt/ccxt/blob/master/CONTRIBUTING.md#how-to-contribute-code

public partial class BaseTest
{
        async public Task testSetMarketsFromExchange()
        {
            var emptyExchange = new ccxt.Exchange(new Dictionary<string, object>() {
                { "id", "sample0" },
            });
            Assert("GO_SKIP_START");
            object methodName = "setMarketsFromExchange";
            object trueClause = isEqual(emptyExchange.safeString(null, null), null);
            object sampleMarket = new Dictionary<string, object>() {
                { "BTC/USD", new Dictionary<string, object>() {
                    { "id", "BtcUsd" },
                    { "symbol", "BTC/USD" },
                    { "base", "BTC" },
                    { "quote", "USD" },
                    { "baseId", "Btc" },
                    { "quoteId", "Usd" },
                    { "type", "spot" },
                    { "spot", true },
                } },
            };
            // Test 1: Basic market sharing
            var exchange1 = new ccxt.Exchange(new Dictionary<string, object>() {
                { "id", "primaryEx" },
                { "markets", sampleMarket },
            });
            var exchange2 = new ccxt.Exchange(new Dictionary<string, object>() {
                { "id", "primaryEx" },
            });
            Assert(isGreaterThan(getArrayLength(new List<object>(((IDictionary<string,object>)exchange1.markets).Keys)), 0), "Markets should be loaded in exchange1");
            // Test error case: exchanges are different
            var differentExchange = new ccxt.Exchange(new Dictionary<string, object>() {
                { "id", "secondaryEx" },
            });
            try
            {
                differentExchange.setMarketsFromExchange(exchange1);
                Assert(!isTrue(trueClause), "Should have thrown an error when using different exchange");
            } catch(Exception error)
            {
                Assert(trueClause);
            }
            // Test error case: sharing from exchange without markets
            var nonloadedExchange = new ccxt.Exchange(new Dictionary<string, object>() {
                { "id", "primaryEx" },
            });
            try
            {
                exchange2.setMarketsFromExchange(nonloadedExchange); // exchange2 has no markets yet
                Assert(!isTrue(trueClause), "Should have thrown error when sharing from exchange without markets");
            } catch(Exception error)
            {
                Assert(trueClause);
            }
            // Test the new setMarketsFromExchange method
            exchange2.setMarketsFromExchange(exchange1);
            // Verify shared markets work
            object neededProps = new List<object>() {"symbols", "currencies", "codes", "markets", "ids", "markets_by_id", "currencies_by_id", "baseCurrencies", "quoteCurrencies"};
            for (object i = 0; isLessThan(i, getArrayLength(neededProps)); postFixIncrement(ref i))
            {
                AssertDeepEqual(emptyExchange, new Dictionary<string, object>() {}, methodName, emptyExchange.getProperty(exchange1, getValue(neededProps, i)), emptyExchange.getProperty(exchange2, getValue(neededProps, i)));
            }
            // Verify that modifying one exchange's markets modifies the other
            // exchange1.markets['ETH/USD'] = { 'id': 'EthUsd', 'symbol': 'ETH/USD', 'base': 'ETH', 'quote': 'USD', 'baseId': 'Eth', 'quoteId': 'Usd', 'type': 'spot', 'spot': true };
            // Assert ('ETH/USD' in exchange2.markets, 'Modifying exchange1 markets should reflect in exchange2');
            // Test 2: loadMarkets on shared markets should not make API call and be very fast
            object startTime = emptyExchange.milliseconds();
            await exchange2.loadMarkets();
            object endTime = emptyExchange.milliseconds();
            // Should be very fast since no API call is made
            object timeTaken = subtract(endTime, startTime);
            Assert(isLessThan(timeTaken, 10), "loadMarkets on shared markets should be fast");
            Assert("GO_SKIP_END");
        }
}