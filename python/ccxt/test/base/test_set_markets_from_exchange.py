import os
import sys

root = os.path.dirname(os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))
sys.path.append(root)

# ----------------------------------------------------------------------------

# PLEASE DO NOT EDIT THIS FILE, IT IS GENERATED AND WILL BE OVERWRITTEN:
# https://github.com/ccxt/ccxt/blob/master/CONTRIBUTING.md#how-to-contribute-code

# ----------------------------------------------------------------------------
# -*- coding: utf-8 -*-

import ccxt.async_support as ccxt  # noqa: F402
from ccxt.test.exchange.base import test_shared_methods  # noqa E402

async def test_set_markets_from_exchange():
    empty_exchange = ccxt.Exchange({
        'id': 'sample0',
    })
    assert 'GO_SKIP_START'
    method_name = 'setMarketsFromExchange'
    true_clause = empty_exchange.safe_string(None, None) is None
    sample_market = {
        'BTC/USD': {
            'id': 'BtcUsd',
            'symbol': 'BTC/USD',
            'base': 'BTC',
            'quote': 'USD',
            'baseId': 'Btc',
            'quoteId': 'Usd',
            'type': 'spot',
            'spot': True,
        },
    }
    # Test 1: Basic market sharing
    exchange1 = ccxt.Exchange({
        'id': 'primaryEx',
        'markets': sample_market,
    })
    exchange2 = ccxt.Exchange({
        'id': 'primaryEx',
    })
    assert len(list(exchange1.markets.keys())) > 0, 'Markets should be loaded in exchange1'
    # Test error case: exchanges are different
    different_exchange = ccxt.Exchange({
        'id': 'secondaryEx',
    })
    try:
        different_exchange.set_markets_from_exchange(exchange1)
        assert not true_clause, 'Should have thrown an error when using different exchange'
    except Exception as error:
        assert true_clause
    # Test error case: sharing from exchange without markets
    nonloaded_exchange = ccxt.Exchange({
        'id': 'primaryEx',
    })
    try:
        exchange2.set_markets_from_exchange(nonloaded_exchange)  # exchange2 has no markets yet
        assert not true_clause, 'Should have thrown error when sharing from exchange without markets'
    except Exception as error:
        assert true_clause
    # Test the new setMarketsFromExchange method
    exchange2.set_markets_from_exchange(exchange1)
    # Verify shared markets work
    needed_props = ['symbols', 'currencies', 'codes', 'markets', 'ids', 'markets_by_id', 'currencies_by_id', 'baseCurrencies', 'quoteCurrencies']
    for i in range(0, len(needed_props)):
        test_shared_methods.assert_deep_equal(empty_exchange, {}, method_name, empty_exchange.get_property(exchange1, needed_props[i]), empty_exchange.get_property(exchange2, needed_props[i]))
    # Verify that modifying one exchange's markets modifies the other
    # exchange1.markets['ETH/USD'] = { 'id': 'EthUsd', 'symbol': 'ETH/USD', 'base': 'ETH', 'quote': 'USD', 'baseId': 'Eth', 'quoteId': 'Usd', 'type': 'spot', 'spot': true };
    # assert ('ETH/USD' in exchange2.markets, 'Modifying exchange1 markets should reflect in exchange2');
    # Test 2: loadMarkets on shared markets should not make API call and be very fast
    start_time = empty_exchange.milliseconds()
    await exchange2.load_markets()
    end_time = empty_exchange.milliseconds()
    # Should be very fast since no API call is made
    time_taken = end_time - start_time
    assert time_taken < 10, 'loadMarkets on shared markets should be fast'
    assert 'GO_SKIP_END'
