<?php
namespace ccxt;

// ----------------------------------------------------------------------------

// PLEASE DO NOT EDIT THIS FILE, IT IS GENERATED AND WILL BE OVERWRITTEN:
// https://github.com/ccxt/ccxt/blob/master/CONTRIBUTING.md#how-to-contribute-code

// -----------------------------------------------------------------------------
use React\Async;
use React\Promise;

function test_set_markets_from_exchange() {
    return Async\async(function () {
        $empty_exchange = new \ccxt\async\Exchange(array(
            'id' => 'sample0',
        ));
        assert('GO_SKIP_START');
        $method_name = 'setMarketsFromExchange';
        $true_clause = $empty_exchange->safe_string(null, null) === null;
        $sample_market = array(
            'BTC/USD' => array(
                'id' => 'BtcUsd',
                'symbol' => 'BTC/USD',
                'base' => 'BTC',
                'quote' => 'USD',
                'baseId' => 'Btc',
                'quoteId' => 'Usd',
                'type' => 'spot',
                'spot' => true,
            ),
        );
        // Test 1: Basic market sharing
        $exchange1 = new \ccxt\async\Exchange(array(
            'id' => 'primaryEx',
            'markets' => $sample_market,
        ));
        $exchange2 = new \ccxt\async\Exchange(array(
            'id' => 'primaryEx',
        ));
        assert(count(is_array($exchange1->markets) ? array_keys($exchange1->markets) : array()) > 0, 'Markets should be loaded in exchange1');
        // Test error case: exchanges are different
        $different_exchange = new \ccxt\async\Exchange(array(
            'id' => 'secondaryEx',
        ));
        try {
            $different_exchange->set_markets_from_exchange($exchange1);
            assert(!$true_clause, 'Should have thrown an error when using different exchange');
        } catch(\Throwable $error) {
            assert($true_clause);
        }
        // Test error case: sharing from exchange without markets
        $nonloaded_exchange = new \ccxt\async\Exchange(array(
            'id' => 'primaryEx',
        ));
        try {
            $exchange2->set_markets_from_exchange($nonloaded_exchange); // exchange2 has no markets yet
            assert(!$true_clause, 'Should have thrown error when sharing from exchange without markets');
        } catch(\Throwable $error) {
            assert($true_clause);
        }
        // Test the new setMarketsFromExchange method
        $exchange2->set_markets_from_exchange($exchange1);
        // Verify shared markets work
        $needed_props = ['symbols', 'currencies', 'codes', 'markets', 'ids', 'markets_by_id', 'currencies_by_id', 'baseCurrencies', 'quoteCurrencies'];
        for ($i = 0; $i < count($needed_props); $i++) {
            assert_deep_equal($empty_exchange, array(), $method_name, $empty_exchange->get_property($exchange1, $needed_props[$i]), $empty_exchange->get_property($exchange2, $needed_props[$i]));
        }
        // Verify that modifying one exchange's markets modifies the other
        // exchange1.markets['ETH/USD'] = { 'id': 'EthUsd', 'symbol': 'ETH/USD', 'base': 'ETH', 'quote': 'USD', 'baseId': 'Eth', 'quoteId': 'Usd', 'type': 'spot', 'spot': true };
        // assert ('ETH/USD' in exchange2.markets, 'Modifying exchange1 markets should reflect in exchange2');
        // Test 2: loadMarkets on shared markets should not make API call and be very fast
        $start_time = $empty_exchange->milliseconds();
        Async\await($exchange2->load_markets());
        $end_time = $empty_exchange->milliseconds();
        // Should be very fast since no API call is made
        $time_taken = $end_time - $start_time;
        assert($time_taken < 10, 'loadMarkets on shared markets should be fast');
        assert('GO_SKIP_END');
    }) ();
}
